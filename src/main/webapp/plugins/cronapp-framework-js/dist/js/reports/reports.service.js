!function(e){angular.module("report.services",[]).service("ReportService",["$http","$compile","$modal",function(e,t,r){var a=$("body"),n=angular.element(a.get(0)).scope();this.getReport=function(t){var r={url:"api/rest/report",method:"POST",data:angular.toJson({reportName:t})};return e(r)},this.getPDF=function(t){var r={url:"api/rest/report/pdf",method:"POST",responseType:"arraybuffer",data:angular.toJson(t)};return e(r)},this.getPDFAsFile=function(t){var r={url:"api/rest/report/pdfasfile",method:"POST",data:angular.toJson(t)};return e(r)},this.openURLContent=function(e){var r=$("#reportViewContext");r.get(0)||(console.log("include[#reportViewContext]"),a.append('<div id="reportViewContext" ng-include="\'plugins/cronapp-framework-js/components/reports/reports.view.html\'"></div>'),t(a)(n));var o=function(){var t=$("<iframe/>");t.attr("frameborder",0);var a=parseInt($(window).height());t.attr("height",a-200),t.attr("width","100%"),t.attr("src",e+"?download=false");var n=$("#reportView .modal-body");n.get(0)?(n.html(t),$("#reportViewContext .modal-dialog").css("width","95%"),setTimeout(function(){console.log("open[#reportViewContext]"),$("body").append(r),$("#reportView").modal()},100)):(console.log("wait[#reportViewContext]"),setTimeout(o,200))};setTimeout(o,200)},this.showParameters=function(e){var t=e.parameters,a=[],n=0,o=function(e){return e.replace(/([.*+?^=!:()|\[\]\/\\])/g,"\\$1")},i=function(e,t,r){return e.replace(new RegExp(o(t),"g"),r)},s=function(){if(n<t.length){var o=t[n++];$.get("plugins/cronapp-framework-js/components/reports/"+o.type+".parameter.html").done(function(e){a.push(i(e,"_field_",o.name)),s()})}else a.length>0&&r.open({templateUrl:"plugins/cronapp-framework-js/components/reports/reports.parameters.html",controller:"ParameterController",resolve:{report:function(){return JSON.parse(JSON.stringify(e))},htmlParameters:function(){return JSON.parse(JSON.stringify(a))}}})}.bind(this);s()},this.mergeParam=function(e,t){for(var r in Object.keys(e)){var a=e[r].name,n=(e[r].value,function(e,t){for(var r in Object.keys(t)){if(e==Object.keys(t[r])[0])return Object.values(t[r])[0]}}(a,t));n&&(e[r].value=n)}return e},this.hasParameterWithOutValue=function(e){for(var t in Object.keys(e))if(!e[t].value)return!0;return!1},this.openReport=function(e,t){this.getReport(e).then(function(e){e&&e.data&&(0==e.data.parameters.length||1==e.data.parameters.length&&"DATA_LIMIT"==e.data.parameters[0].name?this.getPDFAsFile(e.data.reportName).then(function(e){this.openURLContent(e.data)}.bind(this),function(e){var t=cronapi.internal.getErrorMessage(e,e.statusText);n.Notification.error(t)}.bind(this)):(t&&(e.data.parameters=this.mergeParam(e.data.parameters,t)),this.hasParameterWithOutValue(e.data.parameters)?this.showParameters(JSON.parse(JSON.stringify(e.data))):this.getPDFAsFile(e.data).then(function(e){this.openURLContent(e.data)}.bind(this))))}.bind(this))}}])}(app);